
# Send prefix
set-option -g prefix C-a
unbind-key C-b
bind-key C-a send-prefix
bind-key -n C-q send-prefix
# set-option -g prefix C-q bind-key -n C-a send-prefix

# Mouse mode
setw -g mouse on

# Shift arrow to switch windows
# bind -n C-Left previous-window
# bind -n C-Right next-window

# Start windows and panes at 1, not 0
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on

# Bind r to reload tmux configuration with default keybindings restored
bind-key r run-shell '\
    export f=$(mktemp) \
    && tmux -f /dev/null -L temp start-server \; list-keys > $f \
    && tmux unbind -a \; source-file $f \
    && rm -f $f \
    && tmux source-file ~/.tmux.conf \; display-message "~/.tmux.conf reloaded."'

# Don't hardcode /usr/bin/zsh (not true on NixOS). Resolve at tmux startup.
run-shell -b 'tmux set-option -g default-shell "$(command -v zsh)"'
# set -gs terminal-overrides ',*-256color:Tc'
# set -ag terminal-overrides ",xterm-256color:RGB"
# set  -g default-terminal "tmux-256color"
# set -g default-terminal "screen-256color"
# set -g terminal-overrides ',xterm-256color:Tc'

set -g default-terminal "xterm-256color"

if-shell '[ "$(uname)" = "Linux" ]' {
    set -ag terminal-overrides ",xterm-256color:RGB"
}

# set -g default-terminal "tmux-256color"
# set -ag terminal-overrides ",xterm-256color:RGB"

# not sure what to use this for
# set -as terminal-overrides ',xterm*:sitm=\E[3m'
# set -g terminal-overrides ',xterm-256color:Tc'
# set -as terminal-overrides ',xterm*:sitm=\E[3m'





# Equalise pane sizes (bound to cmd+shift+r via ghostty)
bind = select-layout -E

# Auto-equalise panes after splitting or closing
set-hook -g after-split-window "select-layout -E"
set-hook -g pane-exited "select-layout -E"
set-hook -g after-kill-pane "select-layout -E"

# Layouts
bind v select-layout main-vertical
bind h select-layout main-horizontal
bind G run-shell "tmux-grid"
bind | select-layout even-horizontal

# Toggle split direction for current pane (bound to cmd+r via ghostty)
bind Space run-shell "tmux-toggle-split"

# Explode panes into windows / implode back (cmd+shift+e via ghostty)
bind g run-shell "tmux-explode-panes"
# Focus mode: auto-enlarge active pane (cmd+shift+f via ghostty)
bind f run-shell "tmux-focus-mode"

# Pull pane from another window (prefix+j then window number)
bind-key j switch-client -T join
bind-key -T join 1 join-pane -h -s :1
bind-key -T join 2 join-pane -h -s :2
bind-key -T join 3 join-pane -h -s :3
bind-key -T join 4 join-pane -h -s :4
bind-key -T join 5 join-pane -h -s :5
bind-key -T join 6 join-pane -h -s :6
bind-key -T join 7 join-pane -h -s :7
bind-key -T join 8 join-pane -h -s :8
bind-key -T join 9 join-pane -h -s :9

# vim-like pane resizing
bind -r K resize-pane -U 5
bind -r J resize-pane -D 5
bind -r H resize-pane -L 5
bind -r L resize-pane -R 5

# vim-like pane switching
bind -r C-k select-pane -U
bind -r C-j select-pane -D
bind -r C-h select-pane -L
bind -r C-l select-pane -R

# New windows/panes open in the current pane's working directory
bind-key c new-window -c "#{pane_current_path}"
bind-key '"' split-window -c "#{pane_current_path}"
bind-key % split-window -h -c "#{pane_current_path}"

# and now unbind keys
unbind Up
unbind Down
unbind Left
unbind Right

unbind C-Up
unbind C-Down
unbind C-Left
unbind C-Right


# rebind conflicting key prefix-L
# bind -r '/' switch-client -l
bind -r C-b switch-client -l
bind -r C-u switch-client -l
# bind -r p command-prompt
bind -r \; command-prompt
# -Z keeps zoomed state
bind -r '/' last-pane -Z
bind -r C-i last-pane -Z
bind -r C-o last-window
bind -r 9 run-shell "tmux select-window -t $(tmux list-windows | tail -1 | cut -d: -f1)"

# set -g @themepack 'powerline/default/blue'

# set -g @dracula-show-flags false
# set -g @dracula-show-left-icon session
# available plugins: battery, cpu-usage, git, gpu-usage, ram-usage, network, network-bandwidth, network-ping, weather, time
# set -g @dracula-plugins "weather git cpu-usage ram-usage time"

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
# set -g @plugin "charlesnchr/nord-tmux"
# set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'schasse/tmux-jump'
set -g @plugin 'tmux-plugins/tmux-open'

set -g @plugin 'egel/tmux-gruvbox'
set -g @tmux-gruvbox 'dark' # or 'light'

set -g @plugin 'sainnhe/tmux-fzf'

set -g @plugin 'tmux-plugins/tmux-open'

set -g @plugin 'artemave/tmux_capture_last_command_output'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'

# Override status-right after plugins load to add git branch
# Override gruvbox theme colors after plugins load
# Change current window highlight from yellow to periwinkle
set-window-option -g window-status-current-format "#[bg=colour146,fg=colour237,nobold,noitalics,nounderscore]î‚°#[bg=colour146,fg=colour239] #I î‚±#[bg=colour146,fg=colour239,bold] #W#{?window_zoomed_flag,*Z,} #[bg=colour237,fg=colour146,nobold,noitalics,nounderscore]î‚°"

set-option -g status-right ""

# Pane borders: inactive visible but subdued, active bright
set -g pane-border-style "fg=colour239"
set -g pane-active-border-style "fg=colour111,bold"

# Enable second status line for bookmarked sessions
set -g status 2
set -g status-interval 0
set -g pane-border-status top
set -g pane-border-format "#[bg=colour146#,fg=colour239#,bold] #P #[bg=colour237#,fg=colour146#,nobold] #{?@claude_status,#{@claude_status} ,}#T #[fg=colour246]â”‚ #{pane_current_path} "
set -g status-format[1] "#[align=left,fg=colour223,bg=colour237] #(~/bin/tmux-show-bookmarks) #[align=right]#[bg=colour237,fg=colour239,nobold,noitalics,nounderscore]î‚²#[bg=colour239,fg=colour246] %Y-%m-%d î‚³ %H:%M #[bg=colour239,fg=colour248,nobold,noitalics,nounderscore]î‚²#[bg=colour248,fg=colour237] #h #[bg=colour248,fg=colour246,nobold,noitalics,nounderscore]î‚²#[bg=colour246,fg=colour237] #{b:pane_current_path}#{?@git_branch, [#{@git_branch}],} "


set -g set-clipboard on
# set-option -g set-titles on

set -g @command-capture-key t
set -g @command-capture-prompt-pattern 'â¯ '
set -g @command-capture-editor-cmd 'nvim -'

set -g @jump-key 'u'

# None of the below is required anymore. Vim and my fork of nord takes care of it.
# set-window-option -g window-status-current-format "**[#I #W #T]"
# set-window-option -g window-status-format "[#I #W #T]"

set -g allow-rename off
set -g automatic-rename-format '#{?@claude_status,#{@claude_status} ,}#{?@claude_queued,ðŸ“‹ ,}#{?@ssh_host,#{@ssh_host},#{pane_title}}'

# Toggle claude-queue arm/disarm for current pane
bind-key Q run-shell "if [ \"$(tmux show-options -p -v @claude_queued 2>/dev/null)\" = '1' ]; then claude-queue clear >/dev/null; else claude-queue arm >/dev/null; fi"

set-window-option -g mode-keys vi

# Rename pane title (prefix + < , analogous to prefix + , for windows)
bind-key < command-prompt -p "Pane title:" "select-pane -T '%%'"


# keys available: s, t, r, e, u, z
bind-key -r d run-shell "tmux neww -n dashboard ~/bin/tmux-coding-dashboard"
bind-key -r m run-shell "~/bin/tmux-perm-dashboard"
bind-key -r S run-shell "tmux neww tmux-cht.sh"
bind-key -r C-s run-shell "tmuxinator work"

# gets annoying for quitting applications like ranger
# bind-key -r q run-shell "tmuxinator work"

# bind-key -r C-t run-shell "tmuxinator thesis
# bind-key -r C-o run-shell "tmuxinator open-seneca"
# bind-key -r C-r run-shell "tmuxinator ccRestore"
# bind-key -r C-t run-shell "tmuxinator Misc"
bind-key -r C-d run-shell "tmuxinator Home"

# bind-key -r C-r run-shell "tmuxinator Project"
bind-key -r C-r run-shell "tmux select-window -t ranger || tmux new-window -n ranger 'ranger'"
bind-key -r C-e run-shell "tmux select-window -t nvim || tmux new-window -n nvim 'nvim'"
bind-key -r C-t run-shell "tmux select-window -t zsh || tmux new-window -n zsh"
bind-key -r e run-shell "~/bin/tmux-sort-windows.sh"
bind-key Tab run-shell "~/bin/tmux-window-sidebar-toggle"
bind-key -r C-w run-shell "~/bin/tmux-create-windows.sh"

# bind-key -r C-k run-shell "tmuxinator Wizion"

# rather use key for session switch
# bind-key -r C-b run-shell "tmuxinator JobSearch"
bind-key -r E run-shell "tmuxinator conf"
bind-key -r T run-shell "tmuxinator Tunnels"
bind-key -r C-z run-shell "tmuxinator random"
bind-key -r W run-shell "tmuxinator Vimwiki"

bind-key -r V run-shell "~/bin/tmux-vw.sh vw"

# bind-key -r E run-shell "~/bin/tmux-vw.sh tdy"
# bind-key -r Y run-shell "~/bin/tmux-vw.sh ydy"

# bind-key -r H run-shell "~/bin/tmux-sessionizer ~/personal/vim-with-me"
# bind-key -r T run-shell "~/bin/tmux-sessionizer ~/personal/refactoring.nvim"
# bind-key -r N run-shell "~/bin/tmux-sessionizer ~/personal/harpoon"
# bind-key -r S run-shell "~/bin/tmux-sessionizer ~/personal/developer-productivity"

bind-key -r O run-shell "~/bin/tmux-sessionizer ~/2work/gitrepos/aiml-julesos"
bind-key -r I run-shell "~/bin/tmux-sessionizer ~/2work/gitrepos/aiml-lectio"

bind-key -r o run-shell "tmux select-window -t sessionizer 2>/dev/null && tmux send-keys '~/bin/tmux-sessionizer' Enter || tmux neww ~/bin/tmux-sessionizer"

TMUX_FZF_LAUNCH_KEY="C-y"

set -s escape-time 0          # don't split Esc from the next byte

unbind -n M-a                 # remove any plugin/stock binding
bind   -n M-a send-keys Escape a   # send literal Esc, then â€œaâ€


# Quick switch to bookmarked sessions by index (opt+1-5)
bind-key -n M-1 run-shell "~/bin/tmux-switch-to-recent 1"
bind-key -n M-2 run-shell "~/bin/tmux-switch-to-recent 2"
bind-key -n M-3 run-shell "~/bin/tmux-switch-to-recent 3"
bind-key -n M-4 run-shell "~/bin/tmux-switch-to-recent 4"
bind-key -n M-5 run-shell "~/bin/tmux-switch-to-recent 5"

# Bookmark management (prefix+b enters bookmark mode)
bind-key b switch-client -T bookmark
bind-key -T bookmark b run-shell "~/bin/tmux-bookmark-add"
bind-key -T bookmark 1 run-shell "~/bin/tmux-bookmark-session 1"
bind-key -T bookmark 2 run-shell "~/bin/tmux-bookmark-session 2"
bind-key -T bookmark 3 run-shell "~/bin/tmux-bookmark-session 3"
bind-key -T bookmark 4 run-shell "~/bin/tmux-bookmark-session 4"
bind-key -T bookmark 5 run-shell "~/bin/tmux-bookmark-session 5"
bind-key -T bookmark '`' run-shell "~/bin/tmux-bookmark-clear-all"
bind-key -T bookmark s run-shell "~/bin/tmux-bookmark-compact"

# Click on status bars: session name toggles sessionizer, window names switch windows, bookmark bar switches to clicked bookmark
bind-key -n MouseDown1StatusLeft run-shell "tmux select-window -t sessionizer 2>/dev/null && tmux send-keys '~/bin/tmux-sessionizer' Enter || tmux neww ~/bin/tmux-sessionizer"
bind-key -n MouseDown1Status select-window -t =
bind-key -n MouseDown1StatusDefault if-shell -F '#{==:#{mouse_status_line},1}' "run-shell 'tmux set-environment MOUSE_X #{mouse_x}; tmux set-environment MOUSE_W #{client_width}; ~/bin/tmux-bookmark-click'"

# Below is an attempt to solve claude code self-scrolling glitch
# Containment for repaint/scroll storms
# Enable passthrough for Claude Code notifications (requires tmux 3.3+)
set -g allow-passthrough on

# Forward bells from ALL panes (not just active) for Claude Code notifications
set -g bell-action any
set -g monitor-bell on
# setw -g mouse off
set -g history-limit 200000

# Prefer tmux terminfo
set -g default-terminal "tmux-256color"
set -as terminal-features ',tmux-256color:RGB'

# Disable alternate screen switching
set -g terminal-overrides 'xterm*:smcup@:rmcup@'

# agent-deck configuration
# agent-deck-tmux-config-version: 2
# Added by agent-deck installer - 2026-01-30
# https://github.com/asheshgoplani/agent-deck

# Terminal with true color support
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm*:Tc:smcup@:rmcup@"
set -ag terminal-overrides ",*256col*:Tc"

# Performance
set -sg escape-time 0
set -g history-limit 50000

# Mouse support (scroll + drag-to-copy)
set -g mouse on

# Auto-enter copy-mode when scrolling up (critical for WSL compatibility)
# This handles: 1) apps with mouse support, 2) already in copy-mode, 3) normal pane
bind-key -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'copy-mode -e'"

# Scroll bindings in copy-mode (both vi and emacs modes)
bind-key -T copy-mode-vi WheelUpPane send-keys -X scroll-up
bind-key -T copy-mode-vi WheelDownPane send-keys -X scroll-down
bind-key -T copy-mode WheelUpPane send-keys -X scroll-up
bind-key -T copy-mode WheelDownPane send-keys -X scroll-down

# End agent-deck configuration
