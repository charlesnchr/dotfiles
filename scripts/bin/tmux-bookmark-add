#!/opt/homebrew/bin/bash

# Script to add current window to next available bookmark slot
# Usage: tmux-bookmark-add

bookmark_file="$HOME/.cache/tmux-session-bookmarks"

# Get current session name, window id, and pane id
current_session=$(tmux display-message -p '#{session_name}' 2>/dev/null)
current_window_id=$(tmux display-message -p '#{window_id}' 2>/dev/null)
current_pane_id=$(tmux display-message -p '#{pane_id}' 2>/dev/null)

if [[ -z $current_session ]] || [[ -z $current_window_id ]]; then
    echo "Not in a tmux session"
    exit 1
fi

# Read existing bookmarks into associative array
declare -A bookmarks
if [[ -f $bookmark_file ]]; then
    while IFS='=' read -r idx value; do
        [[ -n $idx ]] && bookmarks[$idx]="$value"
    done < "$bookmark_file"
fi

# Check if current pane is already bookmarked
for idx in {1..5}; do
    IFS='|' read -r bm_session bm_window_id bm_pane_id <<< "${bookmarks[$idx]}"
    if [[ "$bm_pane_id" == "$current_pane_id" ]]; then
        exit 0
    fi
done

# Find next available slot
for idx in {1..5}; do
    if [[ -z ${bookmarks[$idx]} ]]; then
        bookmarks[$idx]="$current_session|$current_window_id|$current_pane_id"

        # Write back to file
        > "$bookmark_file"
        for i in {1..5}; do
            if [[ -n ${bookmarks[$i]} ]]; then
                echo "$i=${bookmarks[$i]}" >> "$bookmark_file"
            fi
        done

        tmux refresh-client -S
        exit 0
    fi
done

