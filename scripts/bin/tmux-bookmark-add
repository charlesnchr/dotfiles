#!/opt/homebrew/bin/bash

# Script to add current window to next available bookmark slot
# Usage: tmux-bookmark-add

bookmark_file="$HOME/.cache/tmux-session-bookmarks"

# Get current session name and window id
current_session=$(tmux display-message -p '#{session_name}' 2>/dev/null)
current_window_id=$(tmux display-message -p '#{window_id}' 2>/dev/null)
current_window_name=$(tmux display-message -p '#{window_name}' 2>/dev/null)

if [[ -z $current_session ]] || [[ -z $current_window_id ]]; then
    echo "Not in a tmux session"
    exit 1
fi

# Read existing bookmarks into associative array
declare -A bookmarks
if [[ -f $bookmark_file ]]; then
    while IFS='=' read -r idx value; do
        [[ -n $idx ]] && bookmarks[$idx]="$value"
    done < "$bookmark_file"
fi

# Check if current window is already bookmarked
for idx in {1..5}; do
    IFS='|' read -r bm_session bm_window_id <<< "${bookmarks[$idx]}"
    if [[ "$bm_window_id" == "$current_window_id" ]]; then
        tmux display-message "Window already bookmarked at position $idx"
        exit 0
    fi
done

# Find next available slot
for idx in {1..5}; do
    if [[ -z ${bookmarks[$idx]} ]]; then
        bookmarks[$idx]="$current_session|$current_window_id"

        # Write back to file
        > "$bookmark_file"
        for i in {1..5}; do
            if [[ -n ${bookmarks[$i]} ]]; then
                echo "$i=${bookmarks[$i]}" >> "$bookmark_file"
            fi
        done

        tmux display-message "Bookmarked window '$current_window_name' at position $idx"
        tmux refresh-client -S

        # Ensure watcher is running
        _pid=$(cat "$HOME/.cache/tmux-bookmark-watcher.pid" 2>/dev/null)
        if [[ -z $_pid ]] || ! kill -0 "$_pid" 2>/dev/null; then
            nohup ~/bin/tmux-bookmark-watcher &>/dev/null &
        fi
        exit 0
    fi
done

tmux display-message "All bookmark slots full (use prefix+B+\` to clear)"
