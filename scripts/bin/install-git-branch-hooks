#!/bin/bash

repos_dir="$HOME/2work/gitrepos"
hook_script="$HOME/bin/git-branch-cache-updater"

echo "Installing post-checkout hooks in $repos_dir..."

installed=0
skipped=0

while IFS= read -r repo; do
    hook_file="$repo/.git/hooks/post-checkout"
    
    # Check if .git exists
    if [[ ! -d "$repo/.git" ]]; then
        echo "  Skipping $(basename "$repo") - not a git repo"
        ((skipped++))
        continue
    fi
    
    # Create hooks directory if it doesn't exist
    mkdir -p "$repo/.git/hooks"
    
    # Create or append to post-checkout hook
    if [[ -f $hook_file ]]; then
        # Check if our hook is already there
        if grep -q "git-branch-cache-updater" "$hook_file"; then
            echo "  $(basename "$repo") - hook already installed"
            ((installed++))
            continue
        fi
        # Append to existing hook
        echo "" >> "$hook_file"
        echo "# Update git branch cache for tmux switcher" >> "$hook_file"
        echo "$hook_script" >> "$hook_file"
    else
        # Create new hook
        cat > "$hook_file" << 'HOOK'
#!/bin/bash
# Update git branch cache for tmux switcher
HOOK
        echo "$hook_script" >> "$hook_file"
        chmod +x "$hook_file"
    fi
    
    echo "  $(basename "$repo") - hook installed"
    ((installed++))
done < <(find "$repos_dir" -mindepth 1 -maxdepth 1 -type d)

echo ""
echo "Summary:"
echo "  Installed: $installed"
echo "  Skipped: $skipped"
echo ""
echo "Cache will now auto-update when you checkout branches!"
