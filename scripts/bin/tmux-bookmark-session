#!/opt/homebrew/bin/bash

# Script to toggle bookmark for current window at specified index
# Usage: tmux-bookmark-session <1-5>

index=$1
bookmark_file="$HOME/.cache/tmux-session-bookmarks"

if [[ -z $index ]] || [[ ! $index =~ ^[1-5]$ ]]; then
    echo "Usage: tmux-bookmark-session <1-5>"
    exit 1
fi

# Get current session name, window id, and pane id
current_session=$(tmux display-message -p '#{session_name}' 2>/dev/null)
current_window_id=$(tmux display-message -p '#{window_id}' 2>/dev/null)
current_pane_id=$(tmux display-message -p '#{pane_id}' 2>/dev/null)

if [[ -z $current_session ]] || [[ -z $current_window_id ]]; then
    echo "Not in a tmux session"
    exit 1
fi

# Read existing bookmarks into associative array
declare -A bookmarks
if [[ -f $bookmark_file ]]; then
    while IFS='=' read -r idx_read value; do
        [[ -n $idx_read ]] && bookmarks[$idx_read]="$value"
    done < "$bookmark_file"
fi

# Check if current pane is already bookmarked at this index
IFS='|' read -r bm_session bm_window_id bm_pane_id <<< "${bookmarks[$index]}"
if [[ "$bm_pane_id" == "$current_pane_id" ]]; then
    # Clear the bookmark
    unset "bookmarks[$index]"
else
    # Set the bookmark
    bookmarks[$index]="$current_session|$current_window_id|$current_pane_id"
fi

# Write back to file
> "$bookmark_file"
for idx in {1..5}; do
    if [[ -n ${bookmarks[$idx]} ]]; then
        echo "$idx=${bookmarks[$idx]}" >> "$bookmark_file"
    fi
done

# Force refresh the status bar
tmux refresh-client -S

