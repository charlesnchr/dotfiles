#!/opt/homebrew/bin/bash

# Script to switch to a bookmarked window by index
# Usage: tmux-switch-to-recent <index>

index=$1
bookmark_file="$HOME/.cache/tmux-session-bookmarks"

if [[ -z $index ]] || [[ ! $index =~ ^[1-5]$ ]]; then
    echo "Usage: tmux-switch-to-recent <1-5>"
    exit 1
fi

if [[ ! -f $bookmark_file ]]; then
    echo "No bookmarked windows"
    exit 1
fi

# Load bookmarks
declare -A bookmarks
while IFS='=' read -r idx value; do
    [[ -n $idx ]] && bookmarks[$idx]="$value"
done < "$bookmark_file"

value="${bookmarks[$index]}"

if [[ -z $value ]]; then
    echo "No window bookmarked at index $index"
    exit 1
fi

IFS='|' read -r bm_session bm_window_id bm_pane_id <<< "$value"

# Check if the window still exists
if ! tmux display-message -t "$bm_window_id" -p '' &>/dev/null; then
    tmux display-message "Bookmarked window no longer exists"
    exit 1
fi

# Get the session this window belongs to (may have moved)
actual_session=$(tmux display-message -t "$bm_window_id" -p '#{session_name}' 2>/dev/null)

# Switch to the session, select the window, and select the pane
tmux switch-client -t "$actual_session"
tmux select-window -t "$bm_window_id"
if [[ -n $bm_pane_id ]] && tmux display-message -t "$bm_pane_id" -p '' &>/dev/null; then
    tmux select-pane -t "$bm_pane_id"
fi
