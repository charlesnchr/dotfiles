#!/opt/homebrew/bin/bash

# Script to switch to a bookmarked session by index
# Usage: tmux-switch-to-recent <index>

index=$1
bookmark_file="$HOME/.cache/tmux-session-bookmarks"

if [[ -z $index ]] || [[ ! $index =~ ^[1-5]$ ]]; then
    echo "Usage: tmux-switch-to-recent <1-5>"
    exit 1
fi

if [[ ! -f $bookmark_file ]]; then
    echo "No bookmarked sessions"
    exit 1
fi

# Load bookmarks
declare -A bookmarks
while IFS='=' read -r idx session; do
    [[ -n $idx ]] && bookmarks[$idx]="$session"
done < "$bookmark_file"

session_name="${bookmarks[$index]}"

if [[ -z $session_name ]]; then
    echo "No session bookmarked at index $index"
    exit 1
fi

# Switch to the session (create if it doesn't exist)
if ! tmux has-session -t "$session_name" 2>/dev/null; then
    # Look up path from sessionizer cache
    all_dirs_cache="$HOME/.cache/tmux-sessionizer-all-dirs"
    session_path=""
    if [[ -f $all_dirs_cache ]]; then
        # Session names have dots replaced with underscores, match first field
        while IFS= read -r line; do
            folder=$(echo "$line" | awk '{print $1}')
            if [[ "${folder//./_}" == "$session_name" ]]; then
                session_path=$(echo "$line" | awk '{print $NF}')
                break
            fi
        done < "$all_dirs_cache"
    fi

    if [[ -n $session_path && -d $session_path ]]; then
        tmux new-session -ds "$session_name" -c "$session_path"
    else
        tmux new-session -ds "$session_name"
    fi
fi
tmux switch-client -t "$session_name"
