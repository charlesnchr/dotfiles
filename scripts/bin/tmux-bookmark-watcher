#!/opt/homebrew/bin/bash

# Background process that refreshes the status bar when bookmarked windows
# have recent activity, driving the spinner animation in tmux-show-bookmarks.
# Started by .tmux.conf and kept alive while tmux is running.

pidfile="$HOME/.cache/tmux-bookmark-watcher.pid"
bookmark_file="$HOME/.cache/tmux-session-bookmarks"
frame_file="$HOME/.cache/tmux-bookmark-frame"

# Kill existing watcher if running
if [[ -f $pidfile ]]; then
    old_pid=$(cat "$pidfile" 2>/dev/null)
    if [[ -n $old_pid ]] && kill -0 "$old_pid" 2>/dev/null; then
        kill "$old_pid" 2>/dev/null
        sleep 0.1
    fi
fi

echo $$ > "$pidfile"
trap 'rm -f "$pidfile" "$frame_file"; exit 0' EXIT TERM INT

frame=0

while tmux list-sessions &>/dev/null; do
    # No bookmarks â€” sleep and retry
    if [[ ! -s $bookmark_file ]]; then
        rm -f "$frame_file"
        sleep 2
        continue
    fi

    # Check if any bookmarked window has activity within the last 10 seconds
    has_activity=false
    now=$(date +%s)

    while IFS='=' read -r idx value; do
        [[ -z $value ]] && continue
        IFS='|' read -r _ bm_window_id <<< "$value"
        activity=$(tmux display-message -t "$bm_window_id" -p '#{window_activity}' 2>/dev/null)
        if [[ -n $activity ]] && (( now - activity < 10 )); then
            has_activity=true
            break
        fi
    done < "$bookmark_file"

    if [[ $has_activity == true ]]; then
        echo "$frame" > "$frame_file"
        frame=$(( (frame + 1) % 10 ))

        # Refresh all attached clients
        while IFS= read -r tty; do
            tmux refresh-client -S -t "$tty" 2>/dev/null
        done < <(tmux list-clients -F '#{client_tty}' 2>/dev/null)

        sleep 0.5
    else
        rm -f "$frame_file"
        sleep 2
    fi
done
