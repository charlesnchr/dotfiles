#!/opt/homebrew/bin/bash

# Script to detect which bookmark was clicked and switch to it

# Function to truncate string from beginning if longer than threshold
truncate_beginning() {
    local str="$1"
    local threshold=25
    local truncate_to=20

    if [[ ${#str} -le $threshold ]]; then
        echo "$str"
        return
    fi

    local keep=$((truncate_to - 3))
    echo "...${str: -$keep}"
}

# Get mouse position from tmux environment (set by the binding)
mouse_x=$(tmux show-environment MOUSE_X 2>/dev/null | cut -d= -f2)
client_width=$(tmux show-environment MOUSE_W 2>/dev/null | cut -d= -f2)

if [[ -z $mouse_x ]]; then
    exit 1
fi

# Load bookmarks
bookmark_file="$HOME/.cache/tmux-session-bookmarks"
declare -A bookmarks

if [[ -f $bookmark_file ]]; then
    while IFS='=' read -r idx value; do
        [[ -n $idx ]] && bookmarks[$idx]="$value"
    done < "$bookmark_file"
fi

# Calculate the display width of each bookmark (must match tmux-show-bookmarks logic)
declare -A bookmark_widths
total_width=0

for idx in {1..5}; do
    value="${bookmarks[$idx]}"
    if [[ -z $value ]]; then
        continue
    fi

    IFS='|' read -r bm_session bm_window_id <<< "$value"

    # Check if window still exists
    if ! tmux display-message -t "$bm_window_id" -p '' &>/dev/null; then
        continue
    fi

    window_name=$(tmux display-message -t "$bm_window_id" -p '#{window_name}' 2>/dev/null)
    pane_path=$(tmux display-message -t "$bm_window_id" -p '#{pane_current_path}' 2>/dev/null)

    branch=""
    if [[ -n $pane_path ]] && [[ -d $pane_path ]]; then
        branch=$(git -C "$pane_path" rev-parse --abbrev-ref HEAD 2>/dev/null)
    fi

    display_name="${bm_session}/${window_name}"

    # Calculate width: [idx] + space + display_name + branch
    width=3  # [1], [2], etc.

    display=$(truncate_beginning "$display_name")
    width=$((width + 1 + ${#display}))

    if [[ -n $branch ]]; then
        branch_display=$(truncate_beginning "$branch")
        width=$((width + 1 + ${#branch_display}))
    fi

    if [[ $total_width -gt 0 ]]; then
        total_width=$((total_width + 3))  # " │ "
    fi

    bookmark_widths[$idx]=$width
    total_width=$((total_width + width))
done

# If no bookmarks, exit
if [[ $total_width -eq 0 ]]; then
    exit 0
fi

# Calculate starting position (centered)
start_pos=$(( (client_width - total_width) / 2 ))

# Find which bookmark was clicked
current_pos=$start_pos
clicked_index=""

for idx in {1..5}; do
    if [[ -z ${bookmark_widths[$idx]} ]]; then
        continue
    fi

    # Add separator offset if not first
    if [[ $current_pos -gt $start_pos ]]; then
        current_pos=$((current_pos + 3))  # " │ "
    fi

    # Check if mouse_x is within this bookmark's range
    end_pos=$((current_pos + bookmark_widths[$idx]))

    if [[ $mouse_x -ge $current_pos ]] && [[ $mouse_x -lt $end_pos ]]; then
        clicked_index=$idx
        break
    fi

    current_pos=$end_pos
done

# Switch to the bookmarked window
if [[ -n $clicked_index ]]; then
    value="${bookmarks[$clicked_index]}"
    IFS='|' read -r bm_session bm_window_id <<< "$value"

    if tmux display-message -t "$bm_window_id" -p '' &>/dev/null; then
        actual_session=$(tmux display-message -t "$bm_window_id" -p '#{session_name}' 2>/dev/null)
        tmux switch-client -t "$actual_session"
        tmux select-window -t "$bm_window_id"
    else
    fi
else
    # No bookmark clicked - jump to most recent session
    current_session=$(tmux display-message -p '#{session_name}')
    recent_session=$(tmux list-sessions -F "#{session_last_attached} #{session_name}" 2>/dev/null | sort -rn | awk -v current="$current_session" '$2 != current {print $2; exit}')

    if [[ -n $recent_session ]]; then
        tmux switch-client -t "$recent_session"
    fi
fi
