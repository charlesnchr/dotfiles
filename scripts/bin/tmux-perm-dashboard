#!/opt/homebrew/bin/bash

# Create a persistent dashboard session with live mirrors of all Claude Code panes.
# Each detected Claude Code pane becomes a mirror pane in a tiled layout.
# Falls back to bookmarked windows if no Claude sessions are found.

DASHBOARD_SESSION="_dashboard"
bookmark_file="$HOME/.cache/tmux-session-bookmarks"
SEP=$'\t'

# --- Kill existing dashboard ---
tmux kill-session -t "$DASHBOARD_SESSION" 2>/dev/null

# --- Gather all tmux pane info ---
declare -A pane_info pane_lookup

while IFS="$SEP" read -r pid session wname wid ppath pane_id; do
    [[ -z $pid ]] && continue
    pane_info[$pid]="${session}${SEP}${wname}${SEP}${wid}${SEP}${ppath}${SEP}${pane_id}"
    pane_lookup[$pid]=1
done < <(tmux list-panes -a -F "#{pane_pid}${SEP}#{session_name}${SEP}#{window_name}${SEP}#{window_id}${SEP}#{pane_current_path}${SEP}#{pane_id}")

# --- Find Claude Code panes via process tree ---
# Ordered array of: pane_id \t label
panes=()
declare -A seen_windows

while IFS= read -r claude_pid; do
    [[ -z $claude_pid ]] && continue
    pid=$claude_pid
    while [[ $pid -gt 1 ]]; do
        if [[ -n ${pane_lookup[$pid]:-} ]]; then
            IFS="$SEP" read -r session wname wid ppath pane_id <<< "${pane_info[$pid]}"
            if [[ -n $wid ]] && [[ -z ${seen_windows[$wid]:-} ]]; then
                seen_windows[$wid]=1
                branch=$(git -C "$ppath" rev-parse --abbrev-ref HEAD 2>/dev/null) || branch=""
                label="${session}/${wname}"
                [[ -n $branch ]] && label+="  ($branch)"
                panes+=("${pane_id}${SEP}${label}")
            fi
            break
        fi
        pid=$(ps -p "$pid" -o ppid= 2>/dev/null | tr -d ' ')
        [[ -z $pid ]] && break
    done
done < <(pgrep -x claude 2>/dev/null)

# --- Fallback: bookmarked windows ---
if [[ -f $bookmark_file ]]; then
    while IFS='=' read -r idx value; do
        [[ -z $value ]] && continue
        IFS='|' read -r bm_session bm_window_id <<< "$value"
        [[ -n ${seen_windows[$bm_window_id]:-} ]] && continue
        tmux display-message -t "$bm_window_id" -p '' &>/dev/null || continue

        seen_windows[$bm_window_id]=1
        wname=$(tmux display-message -t "$bm_window_id" -p '#{window_name}' 2>/dev/null)
        ppath=$(tmux display-message -t "$bm_window_id" -p '#{pane_current_path}' 2>/dev/null)
        pane_id=$(tmux display-message -t "$bm_window_id" -p '#{pane_id}' 2>/dev/null)
        branch=$(git -C "$ppath" rev-parse --abbrev-ref HEAD 2>/dev/null) || branch=""
        label="${bm_session}/${wname}"
        [[ -n $branch ]] && label+="  ($branch)"
        panes+=("${pane_id}${SEP}${label}")
    done < "$bookmark_file"
fi

# --- Nothing to show ---
if [[ ${#panes[@]} -eq 0 ]]; then
    tmux display-message "No coding sessions to monitor"
    exit 0
fi

# --- Build the dashboard session ---
# First pane creates the session
IFS="$SEP" read -r first_pane first_label <<< "${panes[0]}"
tmux new-session -d -s "$DASHBOARD_SESSION" \
    "$HOME/bin/tmux-mirror-pane '$first_pane' '$first_label'"

# Remaining panes split into the same window
for (( i=1; i<${#panes[@]}; i++ )); do
    IFS="$SEP" read -r p_id p_label <<< "${panes[$i]}"
    tmux split-window -t "$DASHBOARD_SESSION" \
        "$HOME/bin/tmux-mirror-pane '$p_id' '$p_label'"
    # Re-tile after each split to keep things even
    tmux select-layout -t "$DASHBOARD_SESSION" tiled
done

tmux select-layout -t "$DASHBOARD_SESSION" tiled
tmux switch-client -t "$DASHBOARD_SESSION"
